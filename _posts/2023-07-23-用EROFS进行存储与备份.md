---
layout:     post
title:      用EROFS进行存储与备份
subtitle:   EROFS文件系统使用调查
date:       2023-07-23
author:     wszqkzqk
header-img: img/storage-device/various-media.webp
catalog:    true
tags:       开源软件 系统配置 系统维护 文件系统
---

> 本文封面背景图采用CC-BY-SA-4.0协议，来源于[Wikipedia](https://commons.wikimedia.org/wiki/File:DVD,_USB_flash_drive_and_external_hard_drive.jpg)

## 前言

> 本文主要讨论EROFS文件系统的使用

EROFS是一个只读文件系统，由华为开发，在Linux 5.4中合并到主线内核。EROFS的设计目标是提供**高性能、低资源开销**的只读文件系统，设计上主要针对的场景是ROM、系统分区、应用分区等较**轻量级**的手机或者嵌入式环境。笔者在这里对EROFS在**一般存储与备份**的应用场景下的表现进行研究。

笔者想试用EROFS是因为它可能具有以下优势：

* 布局设计上对随机访问性能进行了优化，可以提供更加强劲的随机访问性能
  * 相比squashfs是按压缩前的内容分块，EROFS是按压缩后的内容分块，可以保证直接访问的压缩内容块大小固定
* 支持POSIX ACL
* 实验性支持块级别的去重
  * 相比squashfs支持的文件级别的去重，EROFS支持的块级别的去重可以更加高效地去重

## EROFS的使用

### EROFS的安装

以Arch Linux为例，目前的内核早已包含EROFS，只需要安装`erofs-utils`即可使用EROFS。

```bash
sudo pacman -S erofs-utils
```

### EROFS的创建

EROFS的创建非常简单，只需要使用`mkfs.erofs`命令即可，例如：

```bash
sudo mkfs.erofs /path/to/image.img /path/to/source
```

在此基础上，我们还可以指定更多参数，例如：

* `-z`：指定压缩算法，可选`lz4`、`lz4hc`、`lamz`，可以在后面加`,`并跟上压缩等级，可以用`:`分隔可选的压缩算法，例如指定压缩等级为12的`lz4hc`算法即为`lz4hc,12`
* `-C`：指定最大物理簇大小，单位为字节，最大为1 MiB，即`1048576`
* `-E`：指定拓展选项
  * `dedupe`：开启去重

### EROFS的挂载

EROFS的挂载非常简单，只需要使用`mount`命令即可，例如：

```bash
sudo mount -t erofs /path/to/image.img /path/to/mountpoint
```

还可以通过fuse的方式挂载，例如：

```bash
sudo erofs-fuse /path/to/image.img /path/to/mountpoint
```

## 效果测试

笔者就存储与备份应用场景对EROFS进行了测试。

## 压缩速率

笔者用`mkfs.erofs`对本地部署的若干个Linux发行版的rootfs进行压缩，共48.02 GiB。

* 开启重复数据删除时，压缩奇慢无比，平均输出速率小于8 MiB/s
* 使用`lz4hc,12`算法时，压缩同样非常缓慢
* 使用`lz4`算法时，平均输出速率约为60 MiB/s，仍然无法跑满机械硬盘的带宽

究其原因，是`mkfs.erofs`仅使用了**单线程**设计，不仅压缩仅由单线程完成，文件读取与重复数据删除全部都在一个线程里面排队，导致文件系统创建速率极低。

## 压缩率

由于只有`lz4`才能在合适的时间内创建出EROFS镜像文件，因此笔者只对`lz4`算法进行了压缩率测试。

经`lz4`压缩后的文件大小为23.4 GiB，压缩率为51.2%；同时，支持多线程压缩而创建时间稍短的`zstd`压缩后的squashfs文件大小仅15.3 GiB，压缩率为33.7%。

## 访问速率

笔者仅在机械硬盘中测试，`lz4`压缩的EROFS能够轻松跑满机械硬盘的带宽和IOPS。

## 总结

EROFS在存储与备份应用场景下的表现并不理想，虽然该文件系统的架构设计和布局都非常优秀，可以提供更加强劲的随机访问性能，但是由于其创建程序`mkfs.erofs`的设计不合理，将各项操作都放在一个线程下，导致了资源利用不充分，创建备份速率极慢，导致其在存储与备份应用场景下的表现并不理想。
