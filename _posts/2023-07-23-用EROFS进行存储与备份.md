---
layout:     post
title:      用EROFS进行存储与备份
subtitle:   试用EROFS文件系统
date:       2023-07-23
author:     wszqkzqk
header-img: img/storage-device/various-media.webp
catalog:    true
tags:       开源软件 系统配置 系统维护 文件系统
---

> 本文封面背景图采用CC-BY-SA-4.0协议，来源于[Wikipedia](https://commons.wikimedia.org/wiki/File:DVD,_USB_flash_drive_and_external_hard_drive.jpg)

## 前言

> 本文主要讨论EROFS文件系统的使用

EROFS是一个只读文件系统，主要由Gao Xiang开发，在Linux 5.4中合并到主线内核。EROFS的设计目标是提供**高性能、低资源开销**的只读文件系统，设计上主要针对的场景是ROM、系统分区、应用分区等较**轻量级**的手机或者嵌入式环境。笔者在这里对EROFS在**一般存储与备份**的应用场景下的表现进行研究。

笔者想试用EROFS是因为它可能具有以下优势：

* 布局设计上对随机访问性能进行了优化，可以提供更加强劲的随机访问性能
  * 相比squashfs是按压缩前的内容分块，EROFS是按压缩后的内容分块，可以保证直接访问的压缩内容块大小固定
* 支持POSIX ACL
* 实验性支持块级别的去重
  * 相比squashfs支持的文件级别的去重，EROFS支持的块级别的去重可以更加高效地去重

```
         |<-    variable-sized extent    ->|<-       VLE         ->|
       clusterofs                        clusterofs              clusterofs
         |                                 |                       |
_________v_________________________________v_______________________v________
... |    .         |              |        .     |              |  .   ...
____|____._________|______________|________.___ _|______________|__.________
    |-> lcluster <-|-> lcluster <-|-> lcluster <-|-> lcluster <-|
         (HEAD)        (NONHEAD)       (HEAD)        (NONHEAD)    .
          .             CBLKCNT            .                    .
           .                               .                  .
            .                              .                .
      _______._____________________________.______________._________________
         ... |              |              |              | ...
      _______|______________|______________|______________|_________________
             |->      big pcluster       <-|-> pcluster <-|
```

## EROFS的使用

### EROFS的安装

以Arch Linux为例，目前的内核早已包含EROFS，只需要安装`erofs-utils`即可使用EROFS。

```bash
sudo pacman -S erofs-utils
```

### EROFS的创建

EROFS的创建非常简单，只需要使用`mkfs.erofs`命令即可，例如：

```bash
sudo mkfs.erofs /path/to/image.img /path/to/source
```

在此基础上，我们还可以指定更多参数，例如：

* `-z`：指定压缩算法，可选`lz4`、`lz4hc`、`lamz`，可以在后面加`,`并跟上压缩等级，可以用`:`分隔可选的压缩算法，例如指定压缩等级为12的`lz4hc`算法即为`lz4hc,12`
* `-C`：指定最大物理簇大小，单位为字节，最大为1 MiB，即`1048576`
* `-E`：指定拓展选项
  * `dedupe`：开启去重

### EROFS的挂载

EROFS的挂载非常简单，只需要使用`mount`命令即可，例如：

```bash
sudo mount -t erofs /path/to/image.img /path/to/mountpoint
```

还可以通过fuse的方式挂载，例如：

```bash
sudo erofs-fuse /path/to/image.img /path/to/mountpoint
```

## 效果测试

笔者就存储与备份应用场景对EROFS进行了测试，并与squashfs进行了对比。

### 创建速率及压缩率

笔者使用不同的压缩参数，测试squashfs和EROFS的创建速率和压缩率。

笔者的测试平台是：

* CPU：AMD 5800H 8c16t 3200 MHz
* 内存：板载美光DDR4 16 GB 3200 MHz
* 存储：致态TiPlus 5000 2 TB
* 发行版：Arch Linux
* Linux：6.4.6
* `erofs-utils`：1.6
* `squashfs-tools`：4.6.1

测试文件为一个装有Xfce桌面环境的Arch Linux容器文件夹，原始大小约为3797448 KiB，squashfs和EROFS的块大小均为1 MiB。

| 文件系统      | 压缩算法 | 压缩等级         | 大小(KiB)   | 压缩率      | 耗时(s)   | 速率(KiB/s)    |
| :------:    | :------: | :------:       | :------:   | :----:     | :----:    | :----------:  |
| squashfs    | zstd  | default (15)      | 1436510.05 | 37.37%     | 43.99     | 86328.69      |
| squashfs    | zstd  | 6                 | 1438565.88 | 37.88%     | 16.77     | 226357.23     |
| squashfs    | zstd  | 3                 | 1493950.67 | 39.58%     | 8.15      | 465885        |
| squashfs    | zstd  | 1                 | 1602424.36 | 42.20%     | 6.96      | 545443        |
| squashfs    | lz4hc | default (9)       | 1951430.30 | 51.39%     | 7.37      | 514986        |
| erofs       | lz4   | default (1)       | 3519608.00 | **92.68%** | 10.24     | 370781        |
| erofs       | lz4hc | 9                 | 1855644.00 | 48.47%     | **388.97**| **9762**      |

可见，EROFS除非采用压缩程度极小的算法等级，否则文件系统的创建将**极度缓慢**，在相同压缩算法与压缩等级的情况下，EROFS的创建比squashfs**慢超过50倍**，远远不如squashfs实用。此外，EROFS的压缩率也不如squashfs。这里**默认**创建squashfs时会**开启重复数据删除**功能，而EROFS的重复数据删除目前还是实验性支持，开启后会导致创建速率雪上加霜，极度缓慢，即使是在最快的lz4算法下，平均输出速度不到1 MB/s，因此这里没有完整测试。

究其原因，是`mkfs.erofs`仅使用了**单线程**设计，不仅压缩仅由单线程完成，文件读取与重复数据删除全部都在一个线程里面排队，导致文件系统创建速率极低，在文件备份的场景下非常不方便。

## 读取测试

笔者对整个文件系统逐文件进行了读取测试，较完整、均衡地包含了随机读取性能和连续读取性能；为了控制变量，两个文件系统均采用压缩等级为9的lz4hc算法压缩，并都用1 MiB的块大小，测试结果如下：

| 文件系统 | 耗时/s |
| :---: | :---: |
| squashfs | 17.83 |
| EROFS | 15.93 |

EROFS的架构优势在这里体现了出来，EROFS的读取速率略高于squashfs，但差距不大，可能是块大小过大，EROFS的文件系统布局收益不明显的原因。

## 总结

EROFS在存储与备份应用场景下的表现目前看来并不理想，虽然该文件系统的架构设计和布局都非常优秀，可以提供更加强劲的随机访问性能，但是由于其现有创建程序`mkfs.erofs`的设计不合理，将各项操作都放在一个线程下，导致了资源利用不充分，创建备份速率极慢，导致其在存储与备份应用场景下的表现并不理想，需要后续优化。
