---
layout:     post
title:      FFmpeg的基础使用
subtitle:   FFmpeg常用功能使用回顾
date:       2022-12-29
author:     星外之神
header-img: img/FFmpeg_Logo_new.webp
catalog:    true
tags:       FFmpeg 媒体文件 开源软件
---

在大一上，笔者曾经花了很多时间来玩FFmpeg的视频转码功能，也体验了FFmpeg的其他用法。笔者用这篇博客来记录FFmpeg的基础使用方法，以便后续回顾。

## 简介

与笔者在[上一篇博客](/2022/12/24/PDF处理工具的使用/)中介绍的内容类似，FFmpeg也是一款开源的媒体处理工具。上一篇博客介绍的GhostScript主要用于处理PDF文件，而Imagemagick主要用于处理各种图片文件。而FFmpeg也可以对图片进行处理与转化，但它同时还具有视频与音频处理的强大功能。有不少视频播放器都以FFmpeg作为后端（例如VLC,以及一大堆国产的乱七糟八的播放器），也有大量的录屏软件使用FFmpeg作为后端（例如OBS Studio，Simple Screen Recoder，以及一大堆国产的乱七糟八的工具），大量的开源视频编辑软件也使用FFmpeg。

## 基本命令形式

FFmpeg的基本命令形式较为简洁，只需要指定输入与输出文件即可：
```bash
ffmpeg -i [输入文件] [输出文件]
```

在此基础上，我们可以进行一定的拓展，例如，输入多个文件：
```bash
ffmpeg -i [输入文件1] -i [输入文件2] [输出文件]
```

有时候，媒体文件中含有多个部分（例如视频、音频、字幕），我们可能只需要其中一个或几个部分，这时我们可以用`-map` 参数指定，传递参数的基本格式为：
```bash
-map [文件序号]:[媒体类型]:[媒体序号]
```

其中，`文件序号`指的是我们通过`-i`参数传递输入文件时该文件出现的序号，从`0`开始编号；`媒体类型`主要分为视频、音频、字幕三种，分别用`v`、`a`、`s`表示；`媒体序号`指的是该媒体流在同类型媒体流中的编号，从`0`开始。`媒体类型`与`媒体序号`这两个参数可选。

默认情况下，FFmpeg将会对媒体文件使用相应格式的默认方式进行重新编码，也可以传递`-c`参数手动指定编码方式，除了表示不重新编码而简单复制的`-c copy`外，其余的编码方式一般都需要指定媒体流的类型（显然不可能用视频编码器去编码音频吧QwQ），例如`-c:v [视频编码器]`、`-c:a [音频编码器]`、`-c:s [字幕编码器]`。

## 进阶操作：硬件加速

### 解码

目前的电脑无论是集显还是独显基本上都会配备专用于视频编解码的ASIC电路，使用ASIC电路进行编解码往往能更加高效省电快速，同时也能降低CPU的占用。

调用显卡的ASIC进行视频编解码的API通常由操作系统封装在API中，这些API在不同的操作系统上不一定相同。

在Windows平台下，一般可以选择微软提供的`dxva2`或者`d3d11va`API进行硬件解码，其中，`dxva2`基于Direct3D 9技术，而`d3d11va`基于Direct3D 11技术，一般而言后者效率较高。FFmpeg使用这两个API解码的命令非常简单，只需要传递`-hwaccel`参数并在其后指定用于硬件加速的API即可：
```bash
ffmpeg -hwaccel dxva2 [...]
ffmpeg -hwaccel d3d11va [...]
```

Linux平台显然无法使用Direct3D相关API进行硬件解码，在Linux平台下，我们一般使用的是更加Unix风的`VAAPI`，VAAPI的使用较Direct3D相关API复杂，除了需要指定硬件加速的API外，还需要指定用于解码的硬件设备的路径，集显一般在`/dev/dri/renderD128`，独显一般在`/dev/dri/renderD129`，例如：
```bash
ffmpeg -hwaccel vaapi -hwaccel_device /dev/dri/renderD128 [...]
ffmpeg -hwaccel vaapi -hwaccel_device /dev/dri/renderD129 [...]
```

### 编码

在对编码码率要求不高时，

## 捐赠

|  **支付宝**  |  **微信支付**  |
|  :----:  |  :----:  |
|  [![](/img/donate-alipay.webp)](/img/donate-alipay.webp)  |  [![](/img/donate-wechatpay.webp)](/img/donate-wechatpay.webp)  |
