---
layout:     post
title:      Pythonå¤šè¿›ç¨‹ä¸Windowsä¸‹exeå°è£…çš„è¸©å‘å®è·µ
subtitle:   multiprocessingã€pyinstallerã€nuitkaçš„å°è¯•
date:       2022-01-20
author:     æ˜Ÿå¤–ä¹‹ç¥
header-img: img/nuitka-pyinstaller.webp
catalog:    true
tags:       python
--- 



## å‰è¨€

ç”±äºç°åœ¨ç”µè„‘CPUçš„å•æ ¸æ€§èƒ½æå‡å·²ç»é‡åˆ°ç“¶é¢ˆï¼Œæœ€è¿‘AMDä¸Intelçš„å¤„ç†å™¨ä¹Ÿé€šè¿‡å †æ ¸æ¥å¤§å¹…æé«˜æ€§èƒ½ï¼Œä¸»æµå¤„ç†å™¨æ—©å·²è¾¾åˆ°äº†è¾¾åˆ°äº†8æ ¸16çº¿ç¨‹ã€‚å› æ­¤ï¼Œåˆç†åˆ©ç”¨å¥½å¤šæ ¸æ€§èƒ½å¯¹ç¨‹åºè¿è¡Œé€Ÿåº¦çš„æå‡éå¸¸é‡è¦ã€‚æœ€è¿‘æˆ‘æ‰“ç®—ç®€å•ä½“éªŒä¸€ä¸‹Pythonçš„`multiprocessing`åº“ä¸­çš„å¤šè¿›ç¨‹åŠŸèƒ½ï½ï½ï½

åœ¨æ‘¸é±¼è¿‡ç¨‹ä¸­ï¼Œé¡ºä¾¿å­¦ä¹ äº†ä¸€ä¸‹ä¸¤ä¸ªæ‰“åŒ…å·¥å…·â€”â€”`nuitka`å’Œ`pyinstaller`çš„ä½¿ç”¨ï¼ˆå½“ç„¶ï¼Œæˆ‘å°è¯•æ‰“åŒ…äº†Windowsç‰ˆæœ¬ï¼Œç”±äºLinuxçš„å¤§å¤šæ•°å‘è¡Œç‰ˆå‡å·²ç»é¢„è£…Pythonï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆæ‰“åŒ…çš„å¿…è¦ï¼‰

## å¤šè¿›ç¨‹è¸©å‘ç»å†

### åº”ç”¨åœºæ™¯é€‰æ‹©

åœ¨å°è¯•`multiprocessing`åº“ä¹‹å‰é¦–å…ˆåº”å½“é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„åº”ç”¨åœºæ™¯ï¼Œè¦æ±‚è®¡ç®—å¤„ç†çš„å¯¹è±¡å¯ä»¥åˆ†æˆè‹¥å¹²å—å¹¶è¡Œè®¡ç®—ã€‚æˆ‘é€‰æ‹©çš„æ˜¯æ•°å€¼ç§¯åˆ†ï¼Œå› ä¸ºæ•°å€¼ç§¯åˆ†æ˜¯å°†ç§¯åˆ†åŒºé—´åˆ†å‰²æˆå¾ˆå¤šå°æ®µï¼Œæ±‚å‡ºæ¯ä¸ªå°æ®µçš„é¢ç§¯ä¹‹åå†ç›¸åŠ ã€‚æ±‚é¢ç§¯çš„è¿‡ç¨‹æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–ä¹‹å‰çš„ç»“æœï¼Œè®¡ç®—ä»»åŠ¡ä¹ŸåŸºæœ¬ä¸Šæ˜¯é‡å¤ç®—å°æ®µé¢ç§¯å’Œç´¯åŠ ï¼Œæ‰€ä»¥å¯ä»¥å°†å¤§çš„ç§¯åˆ†åŒºé—´åˆ†æˆè‹¥å¹²ä¸ªå°åŒºé—´ï¼Œåˆ†åˆ«æ±‚å‡ºæ¯ä¸ªåŒºé—´çš„å€¼ï¼Œæœ€åå†ç›¸åŠ å³å¯ã€‚è¿™ç§è®¡ç®—ä»»åŠ¡å†™æˆå¤šè¿›ç¨‹æ¯”è¾ƒæ–¹ä¾¿

### ä»£ç 

#### å•è¿›ç¨‹çš„ä»£ç 

å…¶å®é€‰æ‹©æ•°å€¼ç§¯åˆ†å™¨è¿™ä¸ªåº”ç”¨è¿˜æœ‰ä¸€ä¸ªåŸå› ï¼Œé‚£å°±æ˜¯å•è¿›ç¨‹ç§¯åˆ†å™¨çš„ä»£ç æˆ‘ä»¥å‰å†™è¿‡ğŸ¤ªğŸ¤ªğŸ¤ªğŸ¤ªğŸ¤ªğŸ¤ª

ä¸ºäº†æé«˜ç²¾åº¦ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰é‡‡ç”¨çŸ©å½¢æ³•ï¼ˆå¸¸å‡½æ•°ï¼‰æˆ–æ¢¯å½¢æ³•ï¼ˆä¸€æ¬¡å‡½æ•°ï¼‰è¿›è¡Œæ‹Ÿåˆï¼Œè€Œæ˜¯ä½¿ç”¨äº†è¾›æ™®æ£®æ³•ï¼ˆäºŒæ¬¡å‡½æ•°ï¼‰æ‹Ÿåˆ

``` python
#!/usr/bin/env python3

from time import time
from math import *
#   æŒ‰ç…§ä¹ æƒ¯åç§°å¯¹éƒ¨åˆ†å‡½æ•°å®šä¹‰åˆ«å

def ln(x):
    return log(x)
def lg(x):
    return log(x, 10)
def arcsin(x):
    return asin(x)
def arccos(x):
    return acos(x)
def arctan(x):
    return atan(x)
def arcsinh(x):
    return asinh(x)
def arccosh(x):
    return acosh(x)
def arctanh(x):
    return atanh(x)
print('''       ç§¯åˆ†å™¨ <ä¸€ä¸ªç®€å•çš„æ•°å€¼ç§¯åˆ†å·¥å…·>
    Copyright (C) 2021-2022 æ˜Ÿå¤–ä¹‹ç¥ <wszqkzqk@qq.com>

æ³¨æ„ï¼šä¸‰è§’å‡½æ•°è¯·å…ˆåŒ–æˆæ­£å¼¦ã€ä½™å¼¦ã€æ­£åˆ‡åŠç›¸åº”çš„åä¸‰è§’å‡½æ•°ï¼ˆç°å·²æ”¯æŒåŒæ›²ä¸‰è§’å‡½æ•°åŠå¯¹åº”çš„åä¸‰è§’å‡½æ•°ï¼‰
     è¯·åŠ¡å¿…ä½¿ç”¨åŠè§’ç¬¦å·ï¼›åœ†å‘¨ç‡è¯·ç”¨"pi"è¡¨ç¤ºï¼›è‡ªç„¶å¯¹æ•°çš„åº•æ•°è¯·ç”¨"e"è¡¨ç¤º
     è¯·ç”¨"*""/"è¡¨ç¤ºä¹˜é™¤ï¼Œ"**"è¡¨ç¤ºä¹˜æ–¹ï¼Œ"abs"è¡¨ç¤ºç»å¯¹å€¼ï¼Œ"ln"æˆ–"log"è¡¨ç¤ºè‡ªç„¶å¯¹æ•°ï¼Œ"lg"è¡¨ç¤ºå¸¸ç”¨å¯¹æ•°ï¼Œ"log(m, n)"è¡¨ç¤ºmå¯¹äºåº•æ•°nçš„å¯¹æ•°
è¯·è¾“å…¥è¢«ç§¯å‡½æ•°ï¼ˆç”¨xè¡¨ç¤ºè‡ªå˜é‡ï¼‰ï¼š''')   # é¢„å¤‡ä¿¡æ¯

fx = input()
print('è¯·è¾“å…¥ç§¯åˆ†çš„ä¸‹é™ï¼š')
start = eval(input())   # ä½¿ç”¨evalå‡½æ•°ï¼Œæ”¯æŒè¾“å…¥è¡¨è¾¾å¼
print('è¯·è¾“å…¥ç§¯åˆ†çš„ä¸Šé™ï¼š')
end = eval(input())
print('è¯·è¾“å…¥åˆ†å‰²æ•°ï¼ˆç”±äºæµ®ç‚¹æ•°å€¼è¿ç®—å…·æœ‰ä¸ç²¾ç¡®æ€§ï¼Œåˆ†å‰²æ•°è¿‡å¤§åè€Œå¯èƒ½å¢å¤§è¯¯å·®ï¼‰')
block = int(input())
calcstart = time()  # è¾“å…¥ç»“æŸï¼Œè®¡ç®—å¼€å§‹ï¼Œè®¡æ—¶

length = (end - start) / block
halflength = length / 2
out = 0
x = start
temp2 = eval(fx)    # åˆå§‹åŒ–xä¸temp2ï¼Œä»¥ä¾¿åç»­è®©temp0è°ƒç”¨ä¸Šä¸€æ¬¡çš„temp2çš„å€¼ï¼Œå¯ä»¥å‡å°è¿ç®—é‡

for i in range(1, block + 1):   # ç§¯åˆ†è¿ç®—ï¼Œè¾›æ™®æ£®æ³•

    temp0 = temp2
    x += halflength
    temp1 = eval(fx)
    x = start + i*length    # æµ®ç‚¹è¿ç®—ä¸­ï¼Œä¹˜ç§¯è¯¯å·®æ¯”ç´¯åŠ å°ï¼Œæ­¤å¤„ç”¨ä¹˜æ³•è™½ç„¶é™ä½äº†é€Ÿåº¦ä½†æ˜¯æé«˜äº†å‡†ç¡®åº¦

    temp2 = eval(fx)
    temp = (temp0 + 4*temp1 + temp2) / 6
    out += temp*length
print('\nå®Œæˆï¼è®¡ç®—è€—æ—¶ï¼š{}s'.format(time() - calcstart))
print('æ•°å€¼ç§¯åˆ†è¿ç®—ç»“æœä¸ºï¼š')
print(out)

input('\nè¯·æŒ‰å›è½¦é”®é€€å‡º')
```
### æ”¹ä¸ºå¤šè¿›ç¨‹

æˆ‘è¿™é‡Œé€‰æ‹©äº†çš„æ˜¯`multiprocessing`ä¸­çš„`Pool`è¿›è¡Œå¤šè¿›ç¨‹è¿ç®—ï¼Œ`Pool`èƒ½ä¸ºæˆ‘çš„ç¨‹åºæä¾›å¾ˆå¤šä¾¿åˆ©ï¼š
- æ–¹ä¾¿æ‰¹é‡å»ºç«‹è¿›ç¨‹
- å†…ç½®äº†`Pool(n).map()`ï¼ˆä»…æ”¯æŒä¸€ä¸ªå‚æ•°ï¼‰å’Œ`Pool(n).starmap()`ï¼ˆæ”¯æŒå¤šä¸ªå‚æ•°ï¼‰å‡½æ•°ï¼Œæ˜¯`map()`å‡½æ•°çš„è¿›ç¨‹æ± ç‰ˆæœ¬ï¼Œå¯ä»¥å¤šè¿›ç¨‹åœ°å¯¹å¯è¿­ä»£å¯¹è±¡è¿›è¡Œç›®æ ‡å‡½æ•°æ“ä½œï¼Œå¹¶è¿”å›`map`å¯¹è±¡
- è¿”å›å¯¹è±¡å¤„ç†æ–¹ä¾¿ï¼Œåªéœ€è¦å¥—ä¸€å±‚`sum()`å‡½æ•°å°±èƒ½å¾—åˆ°æœ€ç»ˆç»“æœ

#### å®šä¹‰ç§¯åˆ†å‡½æ•°

ç”±äº`Pool.starmap()`éœ€è¦è¾“å…¥å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦å®šä¹‰æ¯ä¸€ä¸ªè¿›ç¨‹çš„ç§¯åˆ†å‡½æ•°ï¼š

``` python
# ç”¨äºç§¯åˆ†çš„å‡½æ•°

def integration(blockstart, blockend):
    out = 0
    x = start + blockstart*length
    temp2 = eval(fx)    # åˆå§‹åŒ–xä¸temp2ï¼Œä»¥ä¾¿åç»­è®©temp0è°ƒç”¨ä¸Šä¸€æ¬¡çš„temp2çš„å€¼ï¼Œå¯ä»¥å‡å°è¿ç®—é‡

    for i in range(blockstart + 1, blockend + 1):
        temp0 = temp2
        x += halflength
        temp1 = eval(fx)
        x = start + i*length    # æµ®ç‚¹è¿ç®—ä¸­ï¼Œä¹˜ç§¯è¯¯å·®æ¯”ç´¯åŠ å°ï¼Œæ­¤å¤„ç”¨ä¹˜æ³•è™½ç„¶é™ä½äº†é€Ÿåº¦ä½†æ˜¯æé«˜äº†å‡†ç¡®åº¦

        temp2 = eval(fx)
        temp = (temp0 + 4*temp1 + temp2) / 6
        out += temp*length
    return out
```
#### è¿›ç¨‹æ•°ä¸åŒºé—´åˆ†æ®µ

å½“ç„¶ï¼Œè¿˜éœ€è¦å°†ç§¯åˆ†åŒºé—´åˆ†æˆè‹¥å¹²æ®µï¼Œæ®µæ•°åº”å½“ä¸è¿›ç¨‹æ•°åŒ¹é…ã€‚ä¸ºäº†å……åˆ†åˆ©ç”¨CPUå„ä¸ªè™šæ‹Ÿæ ¸å¿ƒç®—åŠ›ï¼Œå¯ä»¥å…ˆè°ƒç”¨`from os import cpu_count`å†é€šè¿‡`n = cpu_count()`è·å–CPUçš„çº¿ç¨‹æ•°ä»¥è®¾ç½®è¿›ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥è®¾å®šå…¶ä»–åˆç†çš„è¿›ç¨‹æ•°ï¼ˆå¦‚ç‰©ç†æ ¸å¿ƒæ•°ç­‰ï¼‰

``` python
from os import cpu_count
n = cpu_count() # é»˜è®¤ä¸ºè®¾å¤‡çš„é€»è¾‘æ ¸å¿ƒæ•°

tile = int(block / n)
# è¿›è¡Œåˆ†æ®µï¼Œä»¥ä¾¿åˆ†è¿›ç¨‹è®¡ç®—

tilestart = 0
obj = [0]
for i in range(n):
    tilestart += tile
    obj.append(tilestart)
```

#### åˆç‰ˆæ•´ä½“ä»£ç 

```python
from time import time
from os import cpu_count
n = cpu_count()    # é»˜è®¤ä¸ºè®¾å¤‡çš„é€»è¾‘æ ¸å¿ƒæ•°
from multiprocessing import Pool
from math import *
def ln(x):
    return log(x)
def lg(x):
    return log(x, 10)
def arcsin(x):
    return asin(x)
def arccos(x):
    return acos(x)
def arctan(x):
    return atan(x)
def arcsinh(x):
    return asinh(x)
def arccosh(x):
    return acosh(x)
def arctanh(x):
    return atanh(x)
print('''æ³¨æ„ï¼šä¸‰è§’å‡½æ•°è¯·å…ˆåŒ–æˆæ­£å¼¦ã€ä½™å¼¦ã€æ­£åˆ‡åŠç›¸åº”çš„åä¸‰è§’å‡½æ•°ï¼ˆç°å·²æ”¯æŒåŒæ›²ä¸‰è§’å‡½æ•°åŠå¯¹åº”çš„åä¸‰è§’å‡½æ•°ï¼‰
    è¯·åŠ¡å¿…ä½¿ç”¨åŠè§’ç¬¦å·ï¼›åœ†å‘¨ç‡è¯·ç”¨"pi"è¡¨ç¤ºï¼›è‡ªç„¶å¯¹æ•°çš„åº•æ•°è¯·ç”¨"e"è¡¨ç¤º
    è¯·ç”¨"*""/"è¡¨ç¤ºä¹˜é™¤ï¼Œ"**"è¡¨ç¤ºä¹˜æ–¹ï¼Œ"abs"è¡¨ç¤ºç»å¯¹å€¼ï¼Œ"ln"æˆ–"log"è¡¨ç¤ºè‡ªç„¶å¯¹æ•°ï¼Œ"lg"è¡¨ç¤ºå¸¸ç”¨å¯¹æ•°ï¼Œ"log(m, n)"è¡¨ç¤ºmå¯¹äºåº•æ•°nçš„å¯¹æ•°
è¯·è¾“å…¥è¢«ç§¯å‡½æ•°ï¼ˆç”¨xè¡¨ç¤ºè‡ªå˜é‡ï¼‰ï¼š''')
fx = input()
print('è¯·è¾“å…¥ç§¯åˆ†çš„ä¸‹é™ï¼š')
start = eval(input())
print('è¯·è¾“å…¥ç§¯åˆ†çš„ä¸Šé™ï¼š')
end = eval(input())
print('è¯·è¾“å…¥åˆ†å‰²æ•°ï¼ˆå»ºè®®ä¸ºCPUé€»è¾‘æ ¸å¿ƒæ•°çš„æ­£æ•´æ•°å€ï¼›ç”±äºæµ®ç‚¹æ•°å€¼è¿ç®—å…·æœ‰ä¸ç²¾ç¡®æ€§ï¼Œåˆ†å‰²æ•°è¿‡å¤§åè€Œå¯èƒ½å¢å¤§è¯¯å·®ï¼‰ï¼š')
block = int(input())
calcstart = time()
length = (end - start) / block
halflength = length / 2
tile = int(block / n)

# ç”¨äºç§¯åˆ†çš„å‡½æ•°
def integration(blockstart):
    out = 0
    x = start + blockstart*length
    temp2 = eval(fx)    # åˆå§‹åŒ–xä¸temp2ï¼Œä»¥ä¾¿åç»­è®©temp0è°ƒç”¨ä¸Šä¸€æ¬¡çš„temp2çš„å€¼ï¼Œå¯ä»¥å‡å°è¿ç®—é‡
    if blockstart == tilestart:
        blockend = block
    else:
        blockend = blockstart + tile
    for i in range(blockstart + 1, blockend + 1):
        temp0 = temp2
        x += halflength
        temp1 = eval(fx)
        x = start + i*length    # æµ®ç‚¹è¿ç®—ä¸­ï¼Œä¹˜ç§¯è¯¯å·®æ¯”ç´¯åŠ å°ï¼Œæ­¤å¤„ç”¨ä¹˜æ³•è™½ç„¶é™ä½äº†é€Ÿåº¦ä½†æ˜¯æé«˜äº†å‡†ç¡®åº¦
        temp2 = eval(fx)
        temp = (temp0 + 4*temp1 + temp2) / 6
        out += temp*length
    return out

# è¿›è¡Œåˆ†æ®µï¼Œä»¥ä¾¿åˆ†çº¿ç¨‹è®¡ç®—
tilestart = 0
obj = [0]
for i in range(n):
    tilestart += tile
    obj.append(tilestart)

# åˆ†çº¿ç¨‹è®¡ç®—
with Pool(n) as pool:
        out = sum(pool.map(integration, obj))

# æ˜¾ç¤ºè¾“å‡º
print('\nå®Œæˆï¼è®¡ç®—è€—æ—¶ï¼š{} s'.format(time() - calcstart))
print('æ•°å€¼ç§¯åˆ†è¿ç®—ç»“æœä¸ºï¼š')
print(out)
```

### åˆç‰ˆä»£ç è¿è¡Œç»“æœ

ä»¥ä¸Šä»£ç åœ¨æˆ‘çš„Linuxå¹³å°ä¸Šè¿è¡Œæ¯«æ— é—®é¢˜ï¼š

|[![#~Linux-integ-single-multi.webp](/img/Linux-integ-single-multi.webp)](/img/Linux-integ-single-multi.webp)|
|----|
|Linuxä¸‹å•è¿›ç¨‹ä¸å¤šè¿›ç¨‹ç¨‹åºæ•ˆç‡å¯¹æ¯”ï¼šåœ¨100 0000æ¬¡åˆ†å‰²çš„é«˜è®¡ç®—é‡ä¸‹ï¼Œå¤šè¿›ç¨‹ç¨‹åºæ•ˆç‡æ˜¯å•è¿›ç¨‹ç¨‹åºçš„7.5å€|

ä½†æ˜¯åœ¨Windowsä¸‹ä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µï¼š

|[![#~integrator-windows-bug.webp](/img/integrator-windows-bug.webp)](/img/integrator-windows-bug.webp)|
|----|
|  Windowså¹³å°ä¸‹å„ä¸ªå­è¿›ç¨‹ä»å¤´æ‰§è¡Œç¨‹åºï¼Œå¹¶éåªæ‰§è¡Œç›®æ ‡å‡½æ•°  |

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒWindowsä¸‹