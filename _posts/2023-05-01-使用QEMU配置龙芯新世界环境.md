---
layout:     post
title:      ä½¿ç”¨QEMUé…ç½®é¾™èŠ¯æ–°ä¸–ç•Œç¯å¢ƒ
subtitle:   Loongarchæ–°ä¸–ç•Œè¸©å‘è®°å½•
date:       2023-05-01
author:     wszqkzqk
header-img: img/loongarch/loongson-mother-board.webp
catalog:    true
tags:       å¼€æºè½¯ä»¶ å›½äº§ç¡¬ä»¶ ç¤¾å›¢æ´»åŠ¨ ç³»ç»Ÿé…ç½® è™šæ‹ŸåŒ–
---

## å‰è¨€

> æœ¬æ–‡ä¸»è¦è®¨è®ºä½¿ç”¨QEMUé…ç½®é¾™èŠ¯æ–°ä¸–ç•Œç¯å¢ƒçš„æ–¹æ³•

ä½œä¸ºåŒ—äº¬å¤§å­¦Linuxä¿±ä¹éƒ¨æ¢ç´¢é¡¹ç›®çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œæ–°æ¶æ„å¤„ç†å™¨çš„è½¯ä»¶é€‚é…å·¥ä½œæ˜¯æˆ‘ä»¬çš„é‡ç‚¹å·¥ä½œä¹‹ä¸€ã€‚

## QEMUé…ç½®

### å®‰è£…QEMU

é¦–å…ˆï¼Œéœ€è¦å®‰è£…QEMUã€‚

#### Linux

è¿™é‡Œä»¥Arch Linuxä¸ºä¾‹ï¼š

```bash
sudo pacman -S qemu-full
```

ç”±äºArch Linuxçš„è½¯ä»¶éƒ½æ˜¯æœ€æ–°ç‰ˆï¼Œè¿™é‡Œä¸ä¼šå­˜åœ¨å› QEMUç‰ˆæœ¬è¿‡ä½è€Œä¸æ”¯æŒçš„é—®é¢˜ã€‚

#### Windows

æœ¬é¡¹ç›®ä¸»è¦æ˜¯ä¸ºloongarchçš„Arch Linuxé€‚é…è½¯ä»¶ç”Ÿæ€ï¼Œç¬”è€…åœ¨æ­¤å»ºè®®Windowsç”¨æˆ·ä¹Ÿè¦ç†Ÿæ‚‰`pacman`çš„ä½¿ç”¨ï¼Œå› æ­¤åœ¨è¿™é‡Œæ¨èWindowsç”¨æˆ·ä½¿ç”¨MSYS2ä¸­çš„QEMUç¯å¢ƒã€‚

MSYS2å·²ç»åŒ…å«åœ¨äº†wingetçš„è½¯ä»¶åº“ä¸­ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡å‘½ä»¤å®‰è£…ï¼š

```powershell
winget install msys2.msys2
```

å®‰è£…å®Œæˆåï¼Œéœ€è¦å°†MSYS2çš„ç›¸å…³å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„æ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œä»¥ä½¿ç”¨`ucrt64`ç¯å¢ƒä¸ºä¾‹ï¼š

|åœ¨`Path`å˜é‡ä¸­æ·»åŠ çš„å†…å®¹|
|           ----          |
|D:\msys64\ucrt64\bin |
|D:\msys64\usr\bin    |

* æ³¨æ„å°†è·¯å¾„æ›¿æ¢ä¸ºè‡ªå·±çš„è·¯å¾„ã€‚

åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆç°åœ¨çš„Windowsç³»ç»Ÿåº”è¯¥åªéœ€è¦åœ¨å¼€å§‹èœå•çš„æœç´¢æ¡†ä¸­è¾“å…¥`path`å°±èƒ½å¼¹å‡ºï¼‰ä¸­æ·»åŠ å¦‚ä¸‹å˜é‡ï¼š

|       å˜é‡å               |   å˜é‡å€¼   |
|       ----                |    ---    |
|   MSYS2_PATH_TYPE     | inherit   |

é…ç½®å®Œæˆåï¼Œå®‰è£…QEMUï¼ŒåŒæ ·ä»¥`ucrt64`ç¯å¢ƒä¸ºä¾‹ï¼š

```bash
pacman -S mingw-w64-ucrt-x86_64-qemu
```

MSYS2ä¸Arch Linuxä¸€æ ·æ˜¯æ»šåŠ¨æ›´æ–°çš„ï¼Œè¿™é‡Œä¸ä¼šå­˜åœ¨å› QEMUç‰ˆæœ¬è¿‡ä½è€Œä¸æ”¯æŒçš„é—®é¢˜ã€‚

## é•œåƒåŠå›ºä»¶ä¸‹è½½

åŒ—äº¬å¤§å­¦å¼€æºé•œåƒç«™ç›®å‰æ”¶å½•äº†é¾™èŠ¯æ–°ä¸–ç•Œçš„é•œåƒåŠå›ºä»¶ï¼Œå¯ä»¥ä»[è¿™é‡Œ](https://mirrors.pku.edu.cn/loongarch/)ä¸‹è½½ã€‚

* [Loongarchæ–°ä¸–ç•Œå›ºä»¶ä¸‹è½½: QEMU_EFI_7.2.fd](https://mirrors.pku.edu.cn/loongarch/archlinux/images/QEMU_EFI_7.2.fd)
* [Loongarchæ–°ä¸–ç•ŒåŸºæœ¬é•œåƒä¸‹è½½: archlinux-loong64.iso](https://mirrors.pku.edu.cn/loongarch/archlinux/iso/latest/archlinux-loong64.iso)
* [Loongarchæ–°ä¸–ç•ŒXfce GUIé•œåƒä¸‹è½½: archlinux-xfce-2023.01.30.1-loong64.iso](http://lauosc.cn:11232/iso/loong64/archlinux/archlinux-xfce-2023.01.30.1-loong64.iso)
* [Loongarchæ–°ä¸–ç•ŒMATE GUIé•œåƒä¸‹è½½: archlinux-mate-2023.01.30.1-loong64.iso](http://lauosc.cn:11232/iso/loong64/archlinux/archlinux-mate-2023.01.31.1-loong64.iso)

## å®‰è£…

### åˆ›å»ºè™šæ‹Ÿç£ç›˜

å¯ä»¥åˆ›å»ºä¸€ä¸ª`qcow2`æ ¼å¼çš„è™šæ‹Ÿç£ç›˜ï¼Œä¼˜ç‚¹æ˜¯å¯ä»¥åŠ¨æ€åˆ†é…ç©ºé—´ï¼š

```bash
qemu-img create -f qcow2 /home/wszqkzqk/VMs/loongarch/archlinux-loongarch-test.qcow2 100G
```

æ³¨æ„å°†è·¯å¾„æ›¿æ¢ä¸ºè‡ªå·±çš„è·¯å¾„ã€‚

### å¯åŠ¨å®‰è£…é•œåƒ

å¯ä»¥ä½¿ç”¨éGUIçš„é•œåƒè¿›è¡Œå®‰è£…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨GUIçš„é•œåƒè¿›è¡Œå®‰è£…ã€‚ç„¶è€Œï¼ŒGUIé•œåƒçš„å®‰è£…å™¨ç›®å‰ä¸å¯ç”¨ï¼Œå› æ­¤æˆ‘ä»¬æ— è®ºä½¿ç”¨ä»€ä¹ˆé•œåƒï¼Œéƒ½éœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œå®‰è£…ã€‚

å¯¹äºéGUIé•œåƒçš„å®‰è£…ï¼Œå¯ä»¥å‚ç…§[Arch Linuxå®˜æ–¹æ–‡æ¡£](https://wiki.archlinux.org/title/Installation_guide_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))è¿›è¡Œå®‰è£…ã€‚

GUIé•œåƒçš„å‘½ä»¤å®‰è£…ä¹Ÿä¸ä¹‹ç±»ä¼¼ï¼Œæœ¬æ–‡åœ¨æ­¤å¯¹å®‰è£…æµç¨‹è¿›è¡Œç®€å•ç½—åˆ—ã€‚

ä»¥å¸¦æœ‰GUIçš„é•œåƒä¸ºä¾‹ï¼Œé¦–å…ˆéœ€è¦å¯åŠ¨é•œåƒï¼š

```bash
qemu-system-loongarch64 \
    -m 5G \
    -cpu la464-loongarch-cpu \
    -machine virt \
    -smp 4 \
    -bios /home/wszqkzqk/VMs/loongarch/QEMU_EFI_7.2.fd \
    -serial stdio \
    -device virtio-gpu-pci \
    -net nic -net user \
    -device nec-usb-xhci,id=xhci,addr=0x1b \
    -device usb-tablet,id=tablet,bus=xhci.0,port=1 \
    -device usb-kbd,id=keyboard,bus=xhci.0,port=2 \
    -hda /home/wszqkzqk/VMs/loongarch/archlinux-loongarch-test.qcow2 \
    -cdrom /home/wszqkzqk/Downloads/ISOs/loongson/archlinux-xfce-2023.01.30.1-loong64.iso \
    -boot once=d
```

Windowsä¸‹çš„å‘½ä»¤ç±»ä¼¼ï¼Œä½†æ³¨æ„å¦‚æœä¸æ˜¯åœ¨msys2çš„bashä¸­è¿è¡Œè€Œæ˜¯åœ¨Windowsç³»ç»Ÿçš„powershellä¸­è¿è¡Œæ—¶ï¼Œç”¨äºæ¢è¡Œçš„`\`éœ€è¦æ¢æˆ`:

```poweshell
qemu-system-loongarch64 `
    -m 5G `
    -cpu la464-loongarch-cpu `
    -machine virt `
    -smp 4 `
    -bios D:\VMs\QEMU_EFI_7.2.fd `
    -serial stdio `
    -device virtio-gpu-pci `
    -net nic -net user `
    -device nec-usb-xhci,id=xhci,addr=0x1b `
    -device usb-tablet,id=tablet,bus=xhci.0,port=1 `
    -device usb-kbd,id=keyboard,bus=xhci.0,port=2 `
    -hda D:\VMs\archlinux-loongarch-test.qcow2 `
    -cdrom D:\VMs\archlinux-xfce-2023.01.30.1-loong64.iso `
    -boot once=d
```

æ³¨æ„å°†è·¯å¾„æ›¿æ¢ä¸ºè‡ªå·±çš„è·¯å¾„ã€‚å…¶ä¸­ï¼š

* `-m`å‚æ•°æŒ‡å®šå†…å­˜å¤§å°
  * å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œè°ƒæ•´
* `-cpu`å‚æ•°æŒ‡å®šCPUç±»å‹
* `-machine`å‚æ•°æŒ‡å®šæœºå™¨ç±»å‹
* `-smp`å‚æ•°æŒ‡å®šCPUæ ¸å¿ƒæ•°
  * å¯¹äºç›®å‰çš„é¾™èŠ¯æ–°ä¸–ç•Œï¼Œæœ€å¤šæ”¯æŒ4æ ¸
* `-bios`å‚æ•°æŒ‡å®šå›ºä»¶è·¯å¾„
  * å³æŒ‡å®šä¸ºä¹‹å‰ä¸‹è½½çš„`QEMU_EFI_7.2.fd`çš„è·¯å¾„
* `-serial`å‚æ•°æŒ‡å®šä¸²å£
* `-device`å‚æ•°æŒ‡å®šè®¾å¤‡
* `-net`å‚æ•°æŒ‡å®šç½‘ç»œ
* `-hda`å‚æ•°æŒ‡å®šè™šæ‹Ÿç£ç›˜è·¯å¾„
  * å³æŒ‡å®šä¸ºä¹‹å‰åˆ›å»ºçš„`archlinux-loongarch-test.qcow2`çš„è·¯å¾„
* `-cdrom`å‚æ•°æŒ‡å®šé•œåƒè·¯å¾„
  * å³æŒ‡å®šä¸‹è½½çš„`iso`æ–‡ä»¶çš„è·¯å¾„ 
* `-boot`å‚æ•°æŒ‡å®šå¯åŠ¨é¡ºåº
  * `once=d`è¡¨ç¤ºç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä»å…‰ç›˜å¯åŠ¨ï¼Œä¹‹ååˆ™ä»ç¡¬ç›˜å¯åŠ¨
  * ç›®å‰è¯¥é€‰æ‹©é¡¹ä¼¼ä¹å¤±æ•ˆï¼Œéœ€è¦æ‰‹åŠ¨è°ƒèŠ‚å‘½ä»¤ä¸­çš„æŒ‡å®šé¡ºåº

### åˆ†åŒº

å®‰è£…å‰ï¼Œéœ€è¦å¯¹ç£ç›˜è¿›è¡Œåˆ†åŒºã€‚ç”±äºæˆ‘ä»¬ç”¨çš„æ˜¯æœ‰GUIçš„é•œåƒï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨`gparted`è¿›è¡Œåˆ†åŒºğŸ˜‹ğŸ˜‹ğŸ˜‹ã€‚é•œåƒå¹¶ä¸è‡ªå¸¦`gparted`ï¼Œå› æ­¤éœ€è¦è‡ªè¡Œå®‰è£…ï¼š

```bash
sudo pacman -Sy gparted
```

[![#~/img/loongarch/install-gparted.webp](/img/loongarch/install-gparted.webp)](/img/loongarch/install-gparted.webp)

å®‰è£…å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨`gparted`å¯¹ç£ç›˜è¿›è¡Œåˆ†åŒºã€‚

Linuxçš„åˆ†åŒºå¸ƒå±€æ–¹å¼ä¸æ–‡ä»¶ç³»ç»Ÿé€‰æ‹©ç›¸å¯¹è‡ªç”±ï¼Œç”±äºæ˜¯è™šæ‹Ÿæœºï¼Œå»ºè®®ç®€åŒ–å¤„ç†ï¼Œåªéœ€è¦åˆ†å‡º`efi`åˆ†åŒºä¸`/`åˆ†åŒºå³å¯ã€‚è€Œä¸”ï¼Œå¦‚æœé‡‡ç”¨äº†`qcow2`æ ¼å¼çš„è™šæ‹Ÿç£ç›˜ï¼Œåœ¨æ­¤ä¸æ¨èå†ä½¿ç”¨CoWçš„Btrfsæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥å…é€ æˆæ€§èƒ½æŸå¤±ã€‚

åˆ†åŒºå®Œåï¼Œéœ€è¦æ³¨æ„è®¾ç½®`efi`åˆ†åŒºçš„`flag`ä¸º`boot`å’Œ`esp`ï¼Œç¤ºä¾‹å¸ƒå±€å¦‚ä¸‹ï¼š

[![#~/img/loongarch/partition-layout.webp](/img/loongarch/partition-layout.webp)](/img/loongarch/partition-layout.webp)

### å®‰è£…

é¦–å…ˆï¼ŒæŒ‚è½½ç›¸åº”åˆ†åŒºï¼š

```bash
sudo mount /dev/vda2 /mnt
sudo mount /dev/vda1 /mnt/efi --mkdir
```

ç„¶åä½¿ç”¨`pacstrap`å®‰è£…åŸºæœ¬ç³»ç»Ÿï¼š

```bash
sudo pacstrap /mnt --needed base linux linux-firmware
```

å¦‚æœéœ€è¦å®‰è£…å…¶ä»–è½¯ä»¶åŒ…ï¼Œå¯ä»¥åœ¨æ­¤å¤„æ·»åŠ ã€‚ä¾‹å¦‚ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨`grub`å¼•å¯¼ï¼Œå¯ä»¥ï¼š

```bash
sudo pacstrap /mnt --needed base linux linux-firmware grub efibootmgr
```

å¦‚æœéœ€è¦å®‰è£…æ¡Œé¢ç¯å¢ƒã€DMã€å­—ä½“ã€æ–‡ä»¶ç³»ç»Ÿç®¡ç†ã€è¾“å…¥æ³•ç­‰ç»„ä»¶ï¼Œä¹Ÿå¯ä»¥æ·»åŠ åˆ°è¿™é‡Œï¼Œä¾‹å¦‚ï¼š

```bash
sudo pacstrap /mnt --needed base linux linux-firmware \
    base-devel \
    sudo \
    zsh fish \
    grub efibootmgr \
    xfce4 xfce4-goodies \
    lightdm lightdm-gtk-greeter \
    noto-fonts-cjk noto-fonts-emoji \
    btrfs-progs xfsprogs dosfstools exfatprogs f2fs-tools xfsprogs \
    networkmanager \
    nano \
    fcitx5 fcitx5-configtool fcitx5-chinese-addons \
    neofetch \
    ... (å…¶ä»–æ‰€éœ€è½¯ä»¶)
```

* å…·ä½“å®‰è£…ä»€ä¹ˆè½¯ä»¶å¾€å¾€å–å†³äºä¸ªäººçš„éœ€æ±‚/å–œå¥½
* ç›®å‰KDEä¸GNOMEä¸¤å¤§æ¡Œé¢ç¯å¢ƒåœ¨é¾™èŠ¯ä¸Šå°šä¸å¯ç”¨ï¼Œå› æ­¤åªèƒ½ä½¿ç”¨è½»é‡çº§çš„æ¡Œé¢ç¯å¢ƒï¼Œä¾‹å¦‚`xfce4`ã€`lxde`ã€`mate`ç­‰

[![#~/img/loongarch/installation.webp](/img/loongarch/installation.webp)](/img/loongarch/installation.webp)

å®‰è£…å®Œæˆåï¼Œä½¿ç”¨`genfstab`ç”Ÿæˆ`fstab`æ–‡ä»¶ï¼š

```bash
sudo genfstab -U /mnt >> /mnt/etc/fstab
```

`fstab`åœ¨è‡ªåŠ¨ç”Ÿæˆåå¯èƒ½è¿˜éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ï¼Œä¾‹å¦‚å¯ä»¥åŠ å…¥`noatiome`æŒ‚è½½é€‰é¡¹ç­‰ã€‚

### é…ç½®

ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œå¯ä»¥ç¼–è¾‘`/etc/default/grub`ï¼Œå»æ‰`GRUB_CMDLINE_LINUX_DEFAULT`çš„å‚æ•°ä¸­çš„`quiet`ã€‚

æ­¤å¤–ï¼Œä¸ºäº†ä¿è¯è®¿é—®é€Ÿç‡ï¼Œå¯ä»¥ä½¿ç”¨åŒ—å¤§çš„é•œåƒæºï¼Œç¼–è¾‘`/etc/pacman.d/mirrorlist`ï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ï¼š

```
Server = https://mirrors.pku.edu.cn/loongarch/archlinux/$repo/os/$arch
```

å¯¹äºQEMUä¸­çš„è™šæ‹Ÿæœºï¼Œè¿˜éœ€è¦é…ç½®å¯¹virtioç£ç›˜è®¾å¤‡çš„è®¿é—®ï¼Œç¼–è¾‘`/etc/mkinitcpio.conf`ï¼Œåœ¨`MODULES`ä¸€è¡Œæ·»åŠ `virtio virtio_blk virtio_pci virtio_net`ï¼š

```
MODULES="virtio virtio_blk virtio_pci virtio_net"
```

ä½¿ç”¨`arch-chroot`è¿›å…¥æ–°ç³»ç»Ÿï¼š

```bash
sudo arch-chroot /mnt
```

é‡æ–°æ„å»º`initramfs`ï¼š

```bash
mkinitcpio -P
```

è®¾ç½®æ—¶åŒºï¼š

```bash
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
hwclock --systohc
```

è®¾ç½®æœ¬åœ°åŒ–ï¼š

```bash
sed -i 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/g' /etc/locale.gen
sed -i 's/#zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/g' /etc/locale.gen
locale-gen
echo 'LANG=en_US.UTF-8' > /etc/locale.conf
```

è®¾ç½®ä¸»æœºåï¼š

```bash
echo 'loongarch' > /etc/hostname
```

è®¾ç½®rootå¯†ç ï¼š

```bash
passwd
```

å¯ç”¨lightdmä¸ç½‘ç»œç®¡ç†å™¨ï¼š

```bash
systemctl enable lightdm.service
systemctl enable NetworkManager.service
```

åˆ›å»ºérootè´¦æˆ·ï¼š

```bash
useradd -m lcpuloongarch
```

è®¾å®šç”¨æˆ·å¯†ç ï¼š

```bash
passwd lcpuloongarch
```

å°†ç”¨æˆ·åŠ å…¥`wheel`ç”¨æˆ·ç»„ï¼Œä»¥ä¾¿æ”¯æŒ`sudo`æƒé™ï¼š

```bash
usermod -aG wheel lcpuloongarch
```

ç¼–è¾‘`sudo`é…ç½®ï¼Œä¸º`wheel`ç»„åŠ å…¥`sudo`ä½¿ç”¨æƒé™ï¼š

```bash
EDITOR=nano visudo
```

åœ¨ç¼–è¾‘æ—¶å–æ¶ˆ`%wheel      ALL=(ALL): ALL`ä¸€è¡Œçš„æ³¨é‡Šå³å¯ã€‚

### å®‰è£…å¼•å¯¼

å¦‚æœéœ€è¦ä½¿ç”¨`grub`å¼•å¯¼ï¼Œå¯ä»¥ä½¿ç”¨`grub-install`å®‰è£…å¼•å¯¼ï¼š

```bash
grub-install --target=loongarch64-efi --efi-directory=/efi --removable
```

æ³¨æ„ï¼Œè¿™é‡Œçš„`--removable`å‚æ•°**ä¸å¯çœç•¥**ã€‚

å®‰è£…å®Œæˆåï¼Œç”Ÿæˆå¼•å¯¼é…ç½®ï¼š

```bash
grub-mkconfig -o /boot/grub/grub.cfg
```

è‡³æ­¤ï¼Œå®‰è£…å®Œæˆï¼Œå¯ä»¥é€€å‡º`chroot`ç¯å¢ƒï¼Œé‡å¯è¿›å…¥æ–°ç³»ç»Ÿäº†ã€‚

[![#~/img/loongarch/arch-booting.webp](/img/loongarch/arch-booting.webp)](/img/loongarch/arch-booting.webp)

[![#~/img/loongarch/system-info.webp](/img/loongarch/system-info.webp)](/img/loongarch/system-info.webp)

## æèµ 

|  **æ”¯ä»˜å®**  |  **å¾®ä¿¡æ”¯ä»˜**  |
|  :----:  |  :----:  |
|  [![](/img/donate-alipay.webp)](/img/donate-alipay.webp)  |  [![](/img/donate-wechatpay.webp)](/img/donate-wechatpay.webp)  |
